{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Usuarios - USS{% endblock %}

{% block content %}
<div class="dashboard-container">
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="{% static 'images/imgizquierdo.png' %}" alt="USS" class="navbar-logo">
        </div>
        <div class="navbar-menu">
            <a href="{% url 'accounts:dashboard' %}" class="btn-nav">Dashboard</a>
            <a href="{% url 'accounts:create_user' %}" class="btn-nav btn-create">Crear Usuario</a>
            <div class="user-info">
                <svg class="user-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span class="user-name">{{ user.get_full_name|default:user.username }}</span>
            </div>
            <a href="{% url 'accounts:logout' %}" class="btn-logout">Cerrar Sesión</a>
        </div>
    </nav>

    <div class="content-wrapper">
        <div class="content-header">
            <h1>Gestión de Usuarios</h1>
            <p class="subtitle">Administra todos los usuarios del sistema</p>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <div class="users-table">
            <table>
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Nombre Completo</th>
                        <th>Email</th>
                        <th>Tipo</th>
                        <th>Inicios de Sesión</th>
                        <th>Fecha de Registro</th>
                        <th>Último Acceso</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user_item in users %}
                        <tr{% if user_item.has_axes_attempts %} class="axes-blocked-row"{% endif %}>
                            <td>{{ user_item.username }}</td>
                            <td>{{ user_item.get_full_name|default:"-" }}</td>
                            <td>{{ user_item.email|default:"-" }}</td>
                            <td>
                                {% if user_item.user_type == 'admin' %}
                                    <span class="badge badge-admin">Administrador</span>
                                {% else %}
                                    <span class="badge badge-student">Estudiante</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user_item.is_student %}
                                    <div class="login-count-cell">
                                        <span class="count-text">{{ user_item.login_count }} / {{ user_item.max_logins_allowed }}</span>
                                        {% if user_item.is_disabled_by_login_limit %}
                                            <span class="badge badge-danger">Límite alcanzado</span>
                                        {% elif user_item.login_count >= user_item.max_logins_allowed|add:"-1" %}
                                            <span class="badge badge-warning">Cerca del límite</span>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span style="color: #95a5a6;">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ user_item.date_joined|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if user_item.last_login %}
                                    {{ user_item.last_login|date:"d/m/Y H:i" }}
                                    <br>
                                    <small style="color: #7f8c8d;">Hace {{ user_item.last_login|timesince }}</small>
                                {% else %}
                                    <span style="color: #95a5a6;">Nunca</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user_item.is_online %}
                                    <span class="status status-online">
                                        <span class="online-dot"></span>
                                        En línea
                                    </span>
                                {% else %}
                                    <span class="status status-offline">
                                        <span class="offline-dot"></span>
                                        Desconectado
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'accounts:edit_user' user_item.id %}" class="btn-action btn-edit" title="Editar usuario">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </a>

                                    {% if user_item.is_student and user_item.is_disabled_by_login_limit %}
                                        <form method="post" action="{% url 'accounts:reset_user_login_count' user_item.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn-action btn-reset" title="Resetear contador y reactivar">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="23 4 23 10 17 10"></polyline>
                                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                                                </svg>
                                            </button>
                                        </form>
                                    {% endif %}

                                    {% if user_item.has_axes_attempts %}
                                        <form method="post" action="{% url 'accounts:reset_axes_for_user' user_item.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn-action btn-unlock-axes" title="Desbloquear Axes ({{ user_item.axes_failures }} intento{{ user_item.axes_failures|pluralize }} fallido{{ user_item.axes_failures|pluralize }})">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                                    <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
                                                </svg>
                                            </button>
                                        </form>
                                    {% endif %}

                                    {% if user_item.id != user.id %}
                                        {% if user_item.is_active %}
                                            <form method="post" action="{% url 'accounts:toggle_user_status' user_item.id %}" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn-action btn-deactivate" title="Desactivar usuario">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                                    </svg>
                                                </button>
                                            </form>
                                        {% else %}
                                            <form method="post" action="{% url 'accounts:toggle_user_status' user_item.id %}" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn-action btn-activate" title="Activar usuario">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                                    </svg>
                                                </button>
                                            </form>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="9" style="text-align: center;">No hay usuarios registrados.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .dashboard-container {
        min-height: 100vh;
        background-color: #f5f5f5;
    }

    .navbar {
        background: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .navbar-logo {
        height: 50px;
    }

    .navbar-menu {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .btn-nav {
        color: #2c3e50;
        text-decoration: none;
        padding: 8px 15px;
        background-color: #f0f0f0;
        border-radius: 4px;
        transition: background-color 0.3s;
        font-weight: 600;
    }

    .btn-nav:hover {
        background-color: #e0e0e0;
    }

    .btn-create {
        background: linear-gradient(to right, #7ed321, #5cb811);
        color: white;
    }

    .btn-create:hover {
        background: linear-gradient(to right, #6bc21b, #4a9a0f);
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .user-icon {
        color: #2c3e50;
    }

    .user-name {
        color: #2c3e50;
        font-weight: 600;
        font-size: 15px;
    }

    .btn-logout {
        background-color: #e74c3c;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        text-decoration: none;
        transition: background-color 0.3s;
        font-weight: 600;
    }

    .btn-logout:hover {
        background-color: #c0392b;
    }

    .content-wrapper {
        padding: 40px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .content-header {
        margin-bottom: 30px;
    }

    .content-header h1 {
        color: #2c3e50;
        margin: 0 0 5px 0;
    }

    .subtitle {
        color: #7f8c8d;
        margin: 0;
        font-size: 14px;
    }

    .users-table {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: linear-gradient(to right, #2c3e50, #34495e);
        color: white;
    }

    th, td {
        padding: 15px;
        text-align: left;
    }

    tbody tr {
        border-bottom: 1px solid #ecf0f1;
    }

    tbody tr:hover {
        background-color: #f8f9fa;
    }

    .badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-admin {
        background-color: #3498db;
        color: white;
    }

    .badge-student {
        background-color: #9b59b6;
        color: white;
    }

    .badge-danger {
        background-color: #e74c3c;
        color: white;
        font-size: 11px;
        padding: 3px 8px;
    }

    .badge-warning {
        background-color: #f39c12;
        color: white;
        font-size: 11px;
        padding: 3px 8px;
    }

    .login-count-cell {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: flex-start;
    }

    .count-text {
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }

    .status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-online {
        background-color: #d4edda;
        color: #155724;
    }

    .status-offline {
        background-color: #f8f9fa;
        color: #6c757d;
    }

    .online-dot,
    .offline-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .online-dot {
        background-color: #28a745;
        animation: pulse 2s infinite;
    }

    .offline-dot {
        background-color: #6c757d;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .btn-action {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        padding: 8px;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
    }

    .btn-edit {
        background-color: #007bff;
        color: white;
    }

    .btn-edit:hover {
        background-color: #0056b3;
        transform: translateY(-2px);
    }

    .btn-reset {
        background-color: #f39c12;
        color: white;
    }

    .btn-reset:hover {
        background-color: #e67e22;
        transform: translateY(-2px);
    }

    .btn-activate {
        background-color: #28a745;
        color: white;
    }

    .btn-activate:hover {
        background-color: #218838;
        transform: translateY(-2px);
    }

    .btn-deactivate {
        background-color: #dc3545;
        color: white;
    }

    .btn-deactivate:hover {
        background-color: #c82333;
        transform: translateY(-2px);
    }

    .btn-unlock-axes {
        background-color: #6f42c1;
        color: white;
    }

    .btn-unlock-axes:hover {
        background-color: #5a32a3;
        transform: translateY(-2px);
    }

    /* Estilo para filas de usuarios bloqueados por Axes */
    .axes-blocked-row {
        background-color: #fff3cd !important;
        border-left: 4px solid #ffc107;
    }

    .axes-blocked-row:hover {
        background-color: #fff3b8 !important;
    }

    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .navbar {
            flex-direction: column;
            gap: 10px;
        }

        .navbar-menu {
            flex-direction: column;
            width: 100%;
        }

        .content-wrapper {
            padding: 20px;
        }

        .content-header h1 {
            font-size: 24px;
        }

        .users-table {
            overflow-x: auto;
        }

        table {
            font-size: 14px;
        }

        th, td {
            padding: 10px;
        }
    }

    @media (max-width: 480px) {
        .navbar-logo {
            height: 35px;
        }

        .content-wrapper {
            padding: 15px;
        }

        .content-header h1 {
            font-size: 20px;
        }

        table {
            font-size: 12px;
        }

        th, td {
            padding: 8px 5px;
        }

        /* Ocultar algunas columnas en móvil */
        th:nth-child(3), td:nth-child(3),
        th:nth-child(5), td:nth-child(5),
        th:nth-child(6), td:nth-child(6) {
            display: none;
        }
    }
</style>

<script>
// Actualización automática de la tabla de usuarios cada 30 segundos
function updateUsersTable() {
    fetch('/accounts/get-users-data/')
        .then(response => response.json())
        .then(data => {
            if (data.users) {
                const tbody = document.querySelector('.users-table tbody');
                let html = '';

                data.users.forEach(user => {
                    const rowClass = user.has_axes_attempts ? ' class="axes-blocked-row"' : '';

                    html += `<tr${rowClass}>
                        <td>${user.username}</td>
                        <td>${user.full_name}</td>
                        <td>${user.email}</td>
                        <td>
                            ${user.user_type === 'admin'
                                ? '<span class="badge badge-admin">Administrador</span>'
                                : '<span class="badge badge-student">Estudiante</span>'}
                        </td>
                        <td>
                            ${user.is_student ? `
                                <div class="login-count-cell">
                                    <span class="count-text">${user.login_count} / ${user.max_logins_allowed}</span>
                                    ${user.is_disabled_by_login_limit
                                        ? '<span class="badge badge-danger">Límite alcanzado</span>'
                                        : user.login_count >= user.max_logins_allowed - 1
                                            ? '<span class="badge badge-warning">Cerca del límite</span>'
                                            : ''}
                                </div>
                            ` : '<span style="color: #95a5a6;">N/A</span>'}
                        </td>
                        <td>${user.date_joined}</td>
                        <td>
                            ${user.last_login
                                ? user.last_login
                                : '<span style="color: #95a5a6;">Nunca</span>'}
                        </td>
                        <td>
                            ${user.is_online
                                ? '<span class="status status-online"><span class="online-dot"></span>En línea</span>'
                                : '<span class="status status-offline"><span class="offline-dot"></span>Desconectado</span>'}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="/accounts/users/${user.id}/edit/" class="btn-action btn-edit" title="Editar usuario">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </a>
                                ${user.is_student && user.is_disabled_by_login_limit ? `
                                    <form method="post" action="/accounts/users/${user.id}/reset-login-count/" style="display: inline;">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                                        <button type="submit" class="btn-action btn-reset" title="Resetear contador y reactivar">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="23 4 23 10 17 10"></polyline>
                                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                                            </svg>
                                        </button>
                                    </form>
                                ` : ''}
                                ${user.has_axes_attempts ? `
                                    <form method="post" action="/accounts/users/${user.id}/reset-axes/" style="display: inline;">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                                        <button type="submit" class="btn-action btn-unlock-axes" title="Desbloquear Axes (${user.axes_failures} intento${user.axes_failures !== 1 ? 's' : ''} fallido${user.axes_failures !== 1 ? 's' : ''})">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                                <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
                                            </svg>
                                        </button>
                                    </form>
                                ` : ''}
                                ${!user.is_current_user ? (user.is_active ? `
                                    <form method="post" action="/accounts/users/${user.id}/toggle-status/" style="display: inline;">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                                        <button type="submit" class="btn-action btn-deactivate" title="Desactivar usuario">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                            </svg>
                                        </button>
                                    </form>
                                ` : `
                                    <form method="post" action="/accounts/users/${user.id}/toggle-status/" style="display: inline;">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                                        <button type="submit" class="btn-action btn-activate" title="Activar usuario">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                            </svg>
                                        </button>
                                    </form>
                                `) : ''}
                            </div>
                        </td>
                    </tr>`;
                });

                if (data.users.length === 0) {
                    html = '<tr><td colspan="9" style="text-align: center;">No hay usuarios registrados.</td></tr>';
                }

                tbody.innerHTML = html;
            }
        })
        .catch(error => console.error('Error al actualizar usuarios:', error));
}

// Función auxiliar para obtener CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Actualizar cada 30 segundos
setInterval(updateUsersTable, 30000);

// Primera actualización después de 2 segundos
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(updateUsersTable, 2000);
});
</script>
{% endblock %}
